<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alcon MLR Pre-Screening Agent – Results</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --alcon-blue:#0072CE;
      --alcon-blue-600:#035bb0;
      --bg:#F6F8FB;
      --text:#1F2937;
      --muted:#6B7280;
      --card:#FFFFFF;
      --border:#E5E7EB;
      --shadow:0 10px 20px rgba(16,24,40,.06),0 2px 6px rgba(16,24,40,.06);
      --green:#12B76A;
      --amber:#FEC84B;
      --red:#D92D20;
      --teal:#2DD4BF;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      background:var(--bg);
      line-height:1.45;
    }
    .topbar{background:var(--card);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50;}
    .topbar .inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;justify-content:space-between;padding:14px 20px;}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .logo{width:28px;height:28px;border-radius:6px;background:var(--alcon-blue);box-shadow:inset 0 -8px 16px rgba(255,255,255,.25);}
    .brand span{color:var(--alcon-blue)}
    .crumbs{font-size:12px;color:var(--muted)}
    .avatar{width:32px;height:32px;border-radius:999px;background:linear-gradient(135deg,#c7d2fe,#e0e7ff);display:grid;place-items:center;font-weight:600;color:#334155}

    /* Centered canvas at 1400px */
    .wrap{display:flex;justify-content:center;margin:24px auto 64px;padding:0 20px;}
    .grid{
      display:grid;grid-template-columns:1.6fr .8fr;gap:20px;align-items:start;
      max-width:1400px;width:100%;margin:0 auto;
    }
    @media (max-width:960px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);}
    .card h3{margin:0 0 8px;font-size:16px}
    .card .sub{font-size:12px;color:var(--muted)}
    .pad{padding:18px}

    .section-title{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:12px}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    select,button,.btn,textarea,input[type="text"]{
      font-family:inherit;font-size:14px;border-radius:12px;border:1px solid var(--border);
      padding:10px 12px;background:#fff;color:var(--text);
    }
    .btn-primary{background:var(--alcon-blue);border-color:var(--alcon-blue);color:#fff;cursor:pointer}
    .btn-primary:hover{background:var(--alcon-blue-600)}
    .btn{cursor:pointer}
    .btn-outline{background:#fff;color:var(--alcon-blue);border-color:var(--alcon-blue)}
    .link{color:var(--alcon-blue);text-decoration:none}
    .link:hover{text-decoration:underline}

    .score-card{display:grid;gap:14px}
    .score-flex{display:flex;align-items:center;gap:16px}
    .donut{--val:68; --color:var(--amber); width:94px;height:94px;border-radius:50%;display:grid;place-items:center;background:
      conic-gradient(var(--color) calc(var(--val)*1%),#e5e7eb 0);
      position:relative;
    }
    .donut::after{content:"";position:absolute;inset:8px;background:#fff;border-radius:50%;}
    .donut span{position:relative;font-weight:700;color:#111}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px;background:#FFF8E1;color:#8a5800}

    .rules{display:grid;gap:8px}
    .rule{display:flex;align-items:center;justify-content:space-between;font-size:13px;color:var(--muted)}
    .bar{height:6px;background:#eef2f7;border-radius:6px;overflow:hidden;width:120px;margin-left:8px}
    .bar > i{display:block;height:100%;background:var(--alcon-blue);}

    .flags{display:grid;gap:8px}
    .flag{padding:12px;border-radius:12px;border:1px solid var(--border);display:flex;gap:10px;align-items:flex-start}
    .flag.red{background:#FEF3F2;border-color:#FEE4E2}
    .flag.amber{background:#FFFAEB;border-color:#FEF0C7}
    .flag span.badge{font-weight:600}

    .exports{display:grid;gap:8px}
    .btn-block{width:100%;justify-content:center}

    .detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.detail-grid{grid-template-columns:1fr}}

    .issue-card{padding:14px;border-radius:14px;border:1px solid var(--border);background:#FEF3F2}
    .issue-card .sev{font-size:12px;font-weight:700;color:#7A271A;background:#FEE4E2;border:1px solid #FECACA;padding:2px 8px;border-radius:999px}
    .issue-card h4{margin:8px 0 6px}
    .issue-card .ref{font-size:12px;color:#7a7f86}

    .alt-card{padding:14px;border-radius:14px;border:1px solid var(--border);background:#F0FDF4}
    .alt-card .ok{font-size:12px;font-weight:700;color:#065F46;background:#DCFCE7;border:1px solid #bbf7d0;padding:2px 8px;border-radius:999px}
    .alt-actions{display:flex;gap:8px;margin-top:8px}

    .muted{color:var(--muted)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}

    /* Chatbot */
    .chat-card{display:flex;flex-direction:column;height:420px}
    .chat-scroll{flex:1;overflow:auto;display:grid;gap:10px;padding-right:4px}
    .bot{align-self:start;max-width:100%;background:#F8FAFC;border:1px solid var(--border);padding:10px 12px;border-radius:14px}
    .user{align-self:end;max-width:100%;background:#E0F2FE;border:1px solid #BAE6FD;padding:10px 12px;border-radius:14px}
    .chat-input{display:flex;gap:8px;margin-top:10px}
    .chat-input input{flex:1}
  </style>
</head>
<body>
  <header class="topbar" role="banner">
    <div class="inner">
      <div class="brand" aria-label="Alcon">
        <div class="logo" aria-hidden="true"></div>
        <span>Alcon</span>
        <div class="crumbs">MLR Pre-Screening Agent · Results</div>
      </div>
      <div class="avatar" aria-label="User avatar" title="Sarah Chen">SC</div>
    </div>
  </header>

  <main class="wrap" role="main">
    <div class="grid">
      <!-- LEFT: Results -->
      <section class="card pad" aria-labelledby="content-title">
        <div class="section-title">
          <div>
            <h3 id="content-title">Results</h3>
            <div class="sub" id="prodLabel">Analysis for: —</div>
          </div>
          <div class="controls">
            <a href="review.html" class="btn btn-outline">← Back to Review</a>
          </div>
        </div>

        <!-- Original snippet (readonly preview) -->
        <div class="card pad" style="border-radius:12px;border:1px dashed var(--border);background:#FBFCFE;margin-bottom:14px">
          <div class="sub" style="margin-bottom:8px">Submitted Content (preview)</div>
          <div id="preview" style="white-space:pre-wrap;font-size:14px;color:#111;max-height:140px;overflow:auto"></div>
        </div>

        <div class="detail-grid" style="margin-top:6px">
          <div class="card pad score-card" aria-labelledby="score-title">
            <h3 id="score-title">Compliance Score</h3>
            <div class="score-flex">
              <div class="donut" id="donut" aria-label="Compliance score donut"><span id="scoreNum">—</span></div>
              <div>
                <div class="pill" id="scoreLabel">Calculating…</div>
                <div class="rules" style="margin-top:10px">
                  <div class="rule">FDA Compliance <div class="bar"><i id="barFDA" style="width:62%"></i></div><span id="pctFDA">—%</span></div>
                  <div class="rule">FTC Guidelines <div class="bar"><i id="barFTC" style="width:74%"></i></div><span id="pctFTC">—%</span></div>
                  <div class="rule">Internal Standards <div class="bar"><i id="barINT" style="width:85%"></i></div><span id="pctINT">—%</span></div>
                </div>
              </div>
            </div>

            <h3 style="margin-top:6px">Critical Flags</h3>
            <div class="flags" id="flags">
              <!-- filled by script based on content -->
            </div>

            <h3 style="margin-top:6px">Export Report</h3>
            <div class="exports">
              <button class="btn btn-outline btn-block" id="pdfBtn">Export to PDF</button>
              <button class="btn btn-outline btn-block" id="docBtn">Export to Word</button>
              <button class="btn btn-outline btn-block" id="shareBtn">Share Results</button>
            </div>
          </div>

          <!-- Chatbot -->
          <aside class="card pad chat-card" aria-labelledby="chat-title">
            <h3 id="chat-title">Ask about these results</h3>
            <div class="sub" style="margin-bottom:8px">Try: “Why is ‘world’s most advanced’ not allowed?”</div>
            <div class="chat-scroll" id="chatScroll" aria-live="polite"></div>
            <div class="chat-input">
              <input id="chatInput" type="text" placeholder="Ask a question about a flag, rule, or how to fix…" aria-label="Chat input">
              <button class="btn-primary" id="sendBtn">Send</button>
            </div>
          </aside>
        </div>

        <!-- Detailed Analysis -->
        <section class="card pad" style="margin-top:20px" aria-labelledby="detail-title">
          <h3 id="detail-title">Detailed Analysis & Recommendations</h3>
          <div class="detail-grid" style="margin-top:10px">
            <div>
              <div class="issue-card" id="issue1">
                <span class="sev">Critical</span>
                <h4>Unsubstantiated Superiority Claim</h4>
                <div class="muted" id="issue1Quote">“world’s most advanced IOL technology”</div>
                <div class="ref">FDA Reference: 21CFR 202.1(e)(6)(i) – Claims must be substantiated</div>
              </div>
              <div class="issue-card" style="background:#FFFAEB;margin-top:12px" id="issue2">
                <span class="sev" style="color:#7a5a00;background:#FEF0C7;border-color:#FDE68A">High</span>
                <h4>Missing Risk Information</h4>
                <div class="muted">Clinical study references without proper context</div>
                <div class="ref">Safety limitation: Adverse events disclosure required</div>
              </div>
            </div>

            <div>
              <div class="alt-card">
                <span class="ok">Revised Claim</span>
                <div class="muted" style="margin-top:6px" id="revisedClaim">
                  “Clareon PanOptix IOL — an advanced trifocal lens designed to provide near, intermediate, and distance vision.”
                </div>
                <ul class="muted">
                  <li>Removes unsubstantiated superiority language</li>
                  <li>Anchors to approved indications</li>
                </ul>
                <div class="alt-actions">
                  <button class="btn-primary">Accept</button>
                  <button class="btn">Copy</button>
                  <button class="btn">Mark Resolved</button>
                </div>
              </div>

              <div class="alt-card" style="margin-top:12px;background:#ECFEFF;border-color:#CFFAFE">
                <span class="ok" style="color:#0c4a6e;background:#E0F2FE;border-color:#BAE6FD">Added Disclaimer</span>
                <div class="muted" style="margin-top:6px">
                  “Based on clinical study of 123 patients. Individual results may vary. Please see full prescribing information.”
                </div>
                <div class="alt-actions">
                  <button class="btn-primary">Insert</button>
                  <button class="btn">Copy</button>
                </div>
              </div>
            </div>
          </div>
        </section>

      </section>
    </div>
  </main>

  <script>
    // ---------- Rehydrate inputs ----------
    const text = localStorage.getItem('mlr_text') || '';
    const product = localStorage.getItem('mlr_product') || '—';
    const uploadName = localStorage.getItem('mlr_upload_name') || '';
    document.getElementById('prodLabel').textContent =
      `Analysis for: ${product}${uploadName ? ' · File: ' + uploadName : ''}`;
    document.getElementById('preview').textContent = text || '(No text was provided. If you uploaded a file, the analysis is based on file contents.)';

    // --- BEGIN: Align first issue card + show all unsubstantiated phrases ---
    (function alignIssueCardAndShowUnsubstantiated() {
      const txt = text;
      if (!txt) return;

      const patterns = [
        /world[’']?\s*most\s*advanced[^\n\.]*/gi,
        /\bmost\s+advanced\b/gi,
        /\bmost\s+effective\b/gi,
        /\bsafest\b/gi,
        /\bsuperior(?:ity)?\b/gi,
        /\bunsurpassed\b/gi,
        /\bunmatched\b/gi,
        /\bbest\b/gi,
        /#1|\bno\.?\s*1\b/gi,
        /\bleading\b/gi
      ];

      const found = [];
      for (const re of patterns) {
        let m;
        while ((m = re.exec(txt)) !== null) {
          found.push(m[0]);
        }
      }
      const unique = [...new Set(found.map(s => s.trim()))];
      if (unique.length === 0) return;

      const cardEl  = document.getElementById('issue1');
      const titleEl = cardEl?.querySelector('h4');
      const quoteEl = document.getElementById('issue1Quote');

      if (titleEl) titleEl.textContent = 'Unsubstantiated Superiority/Absolute Claims';
      if (quoteEl) quoteEl.textContent = `“${unique[0]}”`;

      if (cardEl) {
        let row = cardEl.querySelector('.badge-row');
        if (!row) {
          row = document.createElement('div');
          row.className = 'badge-row';
          row.style.marginTop = '8px';
          cardEl.appendChild(row);
        }
        row.innerHTML = unique
          .map(word => `<span class="pill" style="margin-right:6px">${word}</span>`)
          .join('');
      }
    })();
    // --- END: Align first issue card + show all unsubstantiated phrases ---

    // ---------- Score model (kept aesthetic) + keyword penalties ----------
    const donut = document.getElementById('donut');
    const scoreNum = document.getElementById('scoreNum');
    const scoreLabel = document.getElementById('scoreLabel');
    const pctFDA = document.getElementById('pctFDA');
    const pctFTC = document.getElementById('pctFTC');
    const pctINT = document.getElementById('pctINT');
    const barFDA = document.getElementById('barFDA');
    const barFTC = document.getElementById('barFTC');
    const barINT = document.getElementById('barINT');

    const len = (text && text.length) ? text.length : 1;
    let score = Math.min(96, Math.max(42, Math.round(42 + Math.log(len) * 10)));

    const riskyRules = [
      { regex:/world[’']?s\s+most\s+advanced/i, badge:'Unsubstantiated Claim', level:'red',   text:'Superiority language requires robust comparative evidence' },
      { regex:/safest/i,                         badge:'Unsubstantiated Claim', level:'red',   text:'“Safest” implies absolute superiority without adequate evidence' },
      { regex:/most\s+effective/i,               badge:'Unsubstantiated Claim', level:'red',   text:'“Most effective” requires head‑to‑head support' },
      { regex:/guarantee(d)?/i,                  badge:'Improper Guarantee',    level:'amber', text:'Outcome guarantees are generally not permitted' },
      { regex:/perfect\s+vision/i,               badge:'Misleading Outcome',    level:'amber', text:'Promises of “perfect vision” overstate results' }
    ];
    const hits = riskyRules.filter(r => r.regex.test(text || ''));

    if (hits.length) score = Math.min(score, 60);
    if (hits.some(h => h.level === 'red')) score = Math.min(score, 48);

    const setDonut = (s) => {
      scoreNum.textContent = s;
      donut.style.setProperty('--val', s);
      let color = s >= 85 ? getComputedStyle(document.documentElement).getPropertyValue('--green')
                : (s >= 70 ? getComputedStyle(document.documentElement).getPropertyValue('--amber')
                : getComputedStyle(document.documentElement).getPropertyValue('--red'));
      donut.style.setProperty('--color', color);
      scoreLabel.textContent = s >= 85 ? 'Compliant – minor cautions'
                          : (s >= 70 ? 'Needs Review – some issues found'
                          : 'High Risk – multiple critical issues');
    };
    setDonut(score);

    const fda = Math.max(50, Math.min(95, score - 6));
    const ftc = Math.max(55, Math.min(96, score - 2));
    const intl = Math.max(60, Math.min(98, score + 8));
    pctFDA.textContent = fda + '%'; barFDA.style.width = fda + '%';
    pctFTC.textContent = ftc + '%'; barFTC.style.width = ftc + '%';
    pctINT.textContent = intl + '%'; barINT.style.width = intl + '%';

    // ---------- Flags render ----------
    const flagsEl = document.getElementById('flags');
    flagsEl.innerHTML = '';
    if (!hits.length) {
      const div = document.createElement('div');
      div.className = 'flag amber';
      div.innerHTML = '<span class="badge">Review Suggested</span> – No critical patterns detected; verify risks & references.';
      flagsEl.appendChild(div);
    } else {
      hits.forEach(h => {
        const div = document.createElement('div');
        div.className = `flag ${h.level}`;
        div.innerHTML = `<span class="badge">${h.badge}</span> – ${h.text}`;
        flagsEl.appendChild(div);
      });
    }

    // Align quote if present
    const found = (text || '').match(/world[’'?]s most advanced[^\n\.]*/i);
    if (found && document.getElementById('issue1Quote')) {
      document.getElementById('issue1Quote').textContent = `“${found[0]}”`;
    }

    // ---------- Export buttons (mock) ----------
    document.getElementById('pdfBtn').addEventListener('click', ()=> alert('PDF export coming soon'));
    document.getElementById('docBtn').addEventListener('click', ()=> alert('Word export coming soon'));
    document.getElementById('shareBtn').addEventListener('click', ()=> alert('Share link copied (mock)'));

    // ---------- Mini Chatbot ----------
    const chatScroll = document.getElementById('chatScroll');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');

    const botSay = (msg) => {
      const b = document.createElement('div');
      b.className = 'bot';
      b.textContent = msg;
      chatScroll.appendChild(b);
      chatScroll.scrollTop = chatScroll.scrollHeight;
    };
    const userSay = (msg) => {
      const u = document.createElement('div');
      u.className = 'user';
      u.textContent = msg;
      chatScroll.appendChild(u);
      chatScroll.scrollTop = chatScroll.scrollHeight;
    };

    const knowledge = {
      unsubstantiated: "Superiority terms (e.g., “safest”, “most effective”, or “world’s most advanced”) require robust, product‑specific evidence (e.g., 21 CFR 202.1(e)).",
      guarantee: "Promising or guaranteeing clinical outcomes is generally considered misleading in promotional materials.",
      outcome: "Phrases like “perfect vision” overpromise; prefer precise, data‑anchored language aligned to approved indications.",
      howFix: "Rewrite to remove superiority/guarantee language, anchor to approved indications, and add nearby risk/disclaimer lines. If a superiority claim is truly needed, coordinate with MLR to assemble adequate comparative evidence."
    };

    const firstMsg = 'Hi! Ask me why something was flagged. Try: “Why is guaranteed flagged?” or “How do I rewrite this claim?”';
    botSay(firstMsg);

    function answer(q) {
      const s = q.toLowerCase();
      if (s.includes('advanced') || s.includes('safest') || s.includes('effective')) return knowledge.unsubstantiated;
      if (s.includes('guarantee')) return knowledge.guarantee;
      if (s.includes('perfect')) return knowledge.outcome;
      if (s.includes('rewrite') || s.includes('fix') || s.includes('acceptable')) return knowledge.howFix;
      const list = hits.length ? hits.map(h => h.badge).join(', ') : 'no specific flags';
      return `Detected: ${list}. Ask “why” about any one of them, or say “how to rewrite” for a safer alternative.`;
    }

    function send() {
      const q = chatInput.value.trim();
      if (!q) return;
      userSay(q);
      chatInput.value = '';
      setTimeout(()=> botSay(answer(q)), 200);
    }
    sendBtn.addEventListener('click', send);
    chatInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ send(); }});
  </script>
</body>
</html>
