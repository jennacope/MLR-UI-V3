<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alcon MLR Pre-Screening Agent – Review</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --alcon-blue:#0072CE;
      --alcon-blue-600:#035bb0;
      --bg:#F6F8FB;
      --text:#1F2937;
      --muted:#6B7280;
      --card:#FFFFFF;
      --border:#E5E7EB;
      --shadow:0 10px 20px rgba(16,24,40,.06),0 2px 6px rgba(16,24,40,.06);
      --green:#12B76A;
      --amber:#FEC84B;
      --red:#D92D20;
      --teal:#2DD4BF;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      background:var(--bg);
      line-height:1.45;
    }
    /* Top bar */
    .topbar{
      background:var(--card);
      border-bottom:1px solid var(--border);
      position:sticky;top:0;z-index:50;
    }
    .topbar .inner{
      max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;justify-content:space-between;padding:14px 20px;
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .logo{width:28px;height:28px;border-radius:6px;background:var(--alcon-blue);box-shadow:inset 0 -8px 16px rgba(255,255,255,.25);}
    .brand span{color:var(--alcon-blue)}
    .crumbs{font-size:12px;color:var(--muted)}
    .avatar{width:32px;height:32px;border-radius:999px;background:linear-gradient(135deg,#c7d2fe,#e0e7ff);display:grid;place-items:center;font-weight:600;color:#334155}

    /* Layout */
    .wrap{max-width:1200px;margin:24px auto 64px;padding:0 20px;}
    .grid{display:grid;grid-template-columns:1.6fr .8fr;gap:20px;align-items:start;}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);}
    .card h3{margin:0 0 8px;font-size:16px}
    .card .sub{font-size:12px;color:var(--muted)}
    .pad{padding:18px}

    .section-title{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:12px}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    select,button,.btn,textarea,input[type="text"]{
      font-family:inherit;font-size:14px;border-radius:12px;border:1px solid var(--border);
      padding:10px 12px;background:#fff;color:var(--text);
    }
    select:focus,textarea:focus,input:focus,button:focus{outline:3px solid rgba(0,114,206,.18)}
    .btn-primary{background:var(--alcon-blue);border-color:var(--alcon-blue);color:#fff;cursor:pointer}
    .btn-primary:hover{background:var(--alcon-blue-600)}
    .btn-outline{background:#fff;color:var(--alcon-blue);border-color:var(--alcon-blue)}

    .dropzone{
      border:2px dashed #cfd8e3;border-radius:12px;padding:24px;display:grid;place-items:center;text-align:center;color:var(--muted);gap:6px
    }
    .dropzone strong{color:var(--text)}

    .textarea{margin-top:12px}
    textarea{width:100%;min-height:120px;resize:vertical}

    .footer-row{display:flex;align-items:center;justify-content:space-between;margin-top:10px;color:var(--muted);font-size:12px}

    /* Placeholder right column on review page */
    .hint{font-size:13px;color:var(--muted);line-height:1.6}
    .hint b{color:#111}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
  </style>
<style>
/* === Enhancements (non-destructive) === */
.composer-wrap{position:relative;border:1px solid var(--border,#e5e7eb);background:var(--surface,#fff);border-radius:16px;box-shadow:var(--shadow,0 8px 30px rgba(0,0,0,.05));overflow:hidden}
.composer-wrap.dragging{outline:2px dashed rgba(0,0,0,.25);outline-offset:-6px}
.composer-textarea{width:100%;border:0;resize:vertical;min-height:180px;padding:14px 16px 18px;background:transparent;font:inherit;color:inherit;line-height:1.5}
.composer-bar{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;border-top:1px solid var(--border,#e5e7eb);background:var(--surface,#fff)}
.composer-left{display:flex;align-items:center;gap:8px}
.composer-plus{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:8px;border:1px solid var(--border,#e5e7eb);background:var(--surface,#fff);cursor:pointer;user-select:none}
.composer-plus:hover{background:var(--hover,rgba(0,0,0,.04))}
.composer-plus::before{content:'+';font-weight:600;font-size:18px;line-height:1}
.composer-hint{color:var(--muted,#6b7280);font-size:12px}
.helper-line{color:var(--muted,#6b7280);font-size:12px;margin-top:6px}

/* Combobox styled like pill select */
.combo-wrap{position:relative}
.combo-input{width:100%;border:1px solid var(--border,#e5e7eb);background:var(--surface,#fff);border-radius:9999px;padding:10px 36px 10px 14px;font:inherit;color:inherit}
.combo-ghost{position:absolute;left:14px;right:36px;top:50%;transform:translateY(-50%);pointer-events:none;opacity:.45;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--muted,#6b7280);font:inherit}
.combo-caret{position:absolute;right:12px;top:50%;transform:translateY(-50%);pointer-events:none}
.combo-list{position:absolute;z-index:30;left:0;right:0;margin-top:6px;max-height:240px;overflow:auto;background:var(--surface,#fff);border:1px solid var(--border,#e5e7eb);border-radius:12px;box-shadow:var(--shadow,0 8px 30px rgba(0,0,0,.08));display:none;padding:6px 0}
.combo-list[aria-hidden="false"]{display:block}
.combo-list li{padding:8px 12px;cursor:pointer}
.combo-list li[aria-selected="true"],.combo-list li:hover{background:var(--hover,rgba(0,0,0,.04))}
#fileBadge{margin-right:10px;font-size:12px;color:var(--muted,#6b7280)}
#fileRemoveBtn{display:none;margin-left:4px;font-size:12px;border:1px solid var(--border);border-radius:8px;padding:2px 6px;background:#fff;cursor:pointer}
</style>
<style>
/* Attachment chip that appears INSIDE the textbox area */
.file-chip{
  position: absolute;
  left: 12px;
  bottom: 48px; /* sits above the composer bar */
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 10px;
  border: 1px solid var(--border, #e5e7eb);
  background: var(--surface, #fff);
  border-radius: 9999px;
  box-shadow: var(--shadow, 0 4px 16px rgba(0,0,0,.06));
  font-size: 12px;
  color: inherit;
}
.file-chip button{
  border: 0;
  background: transparent;
  cursor: pointer;
  font-weight: 600;
  line-height: 1;
}
.file-chip[hidden]{ display: none; }
</style>
</head>
<body>
  <header class="topbar" role="banner">
    <div class="inner">
      <div class="brand" aria-label="Alcon">
        <div class="logo" aria-hidden="true"></div>
        <span>Alcon</span>
        <div class="crumbs">MLR Pre-Screening Agent · Review</div>
      </div>
      <div class="avatar" aria-label="User avatar" title="Sarah Chen">SC</div>
    </div>
  </header>

  <main class="wrap" role="main">
    <div class="grid">
      <!-- LEFT: Content Review -->
      <section class="card pad" aria-labelledby="content-title">
        <div class="section-title">
          <div>
            <h3 id="content-title">Content Review</h3>
            <!-- UPDATED helper sentence -->
            <div class="sub">Begin reviewing Alcon marketing content for the MLR official review below.</div>
          </div>
          <div class="controls">
            <label class="sr-only" for="product">Product</label>
            <select id="product" aria-label="Select product">
              <option>Clareon PanOptix IOL</option>
              <option>Total 30 Contact Lens</option>
            </select>
          </div>
        </div>

        <div class="dropzone" tabindex="0" aria-label="Drag and drop files here" id="drop">
          <div>
            <strong>Drop files here</strong> or click to upload
            <div class="sub">Supports PDF, DOC, DOCX, TXT (max 10MB)</div>
          </div>
        </div>

        <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.txt" style="display:none" />

        <div class="textarea">
          <label class="sr-only" for="paste">Paste promotional content</label>
          <!-- UPDATED placeholder -->
          <textarea id="paste" placeholder="Type, paste, or drag and drop content here"></textarea>
        </div>

        <div class="footer-row">
          <div><span id="charCount">0</span>/5000 characters</div>
          <button class="btn-primary" id="analyze">Analyze Content</button>
        </div>
      </section>

      <!-- RIGHT: Helpful tips -->
      <aside class="card pad">
        <h3>Tips</h3>
        <p class="hint">
          • Keep claims anchored to <b>approved indications</b>.<br>
          • Avoid <b>superiority language</b> unless substantiated.<br>
          • Pair benefits with <b>material risk info</b> and context.<br>
          • Include <b>clear disclaimers</b> and references where needed.
        </p>
      </aside>
    </div>
  </main>

  <script>
    const textarea = document.getElementById('paste');
    const charCount = document.getElementById('charCount');
    const analyzeBtn = document.getElementById('analyze');
    const product = document.getElementById('product');
    const drop = document.getElementById('drop');
    const fileInput = document.getElementById('fileInput');

    // helper to insert plain text at cursor
    function insertAtCursor(el, text){
      const start = el.selectionStart ?? el.value.length;
      const end   = el.selectionEnd ?? el.value.length;
      const before = el.value.slice(0, start);
      const after  = el.value.slice(end);
      const needsLeadingNewline = before && !before.endsWith('\\n');
      const insertion = (needsLeadingNewline ? '\\n' : '') + text;
      el.value = before + insertion + after;
      // restore caret
      const newPos = (before + insertion).length;
      el.selectionStart = el.selectionEnd = newPos;
      el.dispatchEvent(new Event('input', { bubbles: true }));
    }

    textarea.addEventListener('input', () => {
      charCount.textContent = textarea.value.length;
    });

    drop.addEventListener('click', () => fileInput.click());
    drop.addEventListener('dragover', (e) => { e.preventDefault(); drop.style.borderColor = '#a5b4fc'; });
    drop.addEventListener('dragleave', () => { drop.style.borderColor = '#cfd8e3'; });
    drop.addEventListener('drop', (e) => {
      e.preventDefault();
      drop.style.borderColor = '#cfd8e3';
      const f = e.dataTransfer.files?.[0];
      if (f) {
        localStorage.setItem('mlr_upload_name', f.name);
        // Insert ONLY the filename into the textarea at cursor
        insertAtCursor(textarea, f.name);
      }
    });
    fileInput.addEventListener('change', () => {
      if (fileInput.files?.[0]) {
        localStorage.setItem('mlr_upload_name', fileInput.files[0].name);
        // Insert ONLY the filename into the textarea at cursor on upload as well
        insertAtCursor(textarea, fileInput.files[0].name);
      }
    });

    analyzeBtn.addEventListener('click', () => {
      const text = textarea.value.trim();
      const prod = product.value;
      localStorage.setItem('mlr_text', text);
      localStorage.setItem('mlr_product', prod);
      window.location.href = 'results.html';
    });
  </script>

<script>
document.addEventListener('DOMContentLoaded', function(){
  // ===== Helper line under Content Review title =====
  (function helperLine(){
    const textarea = document.getElementById('paste');
    if (!textarea) return;
    const card = textarea.closest('.card'); if (!card) return;
    const hd = card.querySelector('.hd') || card.querySelector('header,.header'); if (!hd) return;
    let help = document.getElementById('contentHelpLine');
    if (!help){ help = document.createElement('div'); help.id='contentHelpLine'; help.className='helper-line'; hd.appendChild(help); }
    help.textContent = 'Begin reviewing content against compliance standards to prepare for MLR Official Review.';
  })();

  // ===== ChatGPT-style composer =====
  (function composer(){
    const textarea = document.getElementById('paste'); if (!textarea) return;
    const analyze  = document.getElementById('analyze');
    const oldDrop  = document.getElementById('drop'); if (oldDrop) oldDrop.style.display='none';
    let fileInput  = document.getElementById('fileInput');
    if (!fileInput){ fileInput = document.createElement('input'); fileInput.type='file'; fileInput.id='fileInput'; fileInput.accept='.txt,.doc,.docx,.pdf,.rtf,.md,.html,.csv'; fileInput.style.display='none'; textarea.parentNode.insertBefore(fileInput, textarea); }

    const wrap = document.createElement('div'); wrap.className='composer-wrap';
    textarea.classList.add('composer-textarea'); textarea.placeholder='Type, paste, or drag and drop content here…';
    const bar  = document.createElement('div'); bar.className='composer-bar';
    const left = document.createElement('div'); left.className='composer-left';
    const plus = document.createElement('button'); plus.type='button'; plus.className='composer-plus'; plus.title='Upload file'; plus.setAttribute('aria-label','Upload file'); plus.addEventListener('click',()=>fileInput.click()); left.appendChild(plus);
    const hint = document.createElement('span'); hint.className='composer-hint'; hint.textContent='Upload file'; left.appendChild(hint);
    const right= document.createElement('div');
    let count  = document.getElementById('charCount'); if (!count){ count=document.createElement('span'); count.id='charCount'; count.className='composer-hint'; }
    count.setAttribute('aria-live','polite'); count.setAttribute('aria-atomic','true');
    const badge = document.createElement('span'); badge.id='fileBadge'; right.appendChild(badge);
    // Add a minimal remove button next to badge (fallback control)
    const removeBtn = document.createElement('button');
    removeBtn.id = 'fileRemoveBtn';
    removeBtn.type = 'button';
    removeBtn.textContent = 'Remove';
    removeBtn.title = 'Remove attachment';
    removeBtn.setAttribute('aria-label','Remove attachment');
    removeBtn.style.display = 'none';
    removeBtn.addEventListener('click', ()=>{
      try { localStorage.removeItem('mlr_upload_name'); } catch {}
      badge.textContent = '';
      removeBtn.style.display = 'none';
      // hide chip if present
      const chip = document.getElementById('fileChip');
      if (chip) chip.setAttribute('hidden','');
    });
    right.appendChild(removeBtn);

    // live count removed from bar; will use bottom-left indicator
    bar.appendChild(left); bar.appendChild(right);
    const parent = textarea.parentNode; parent.insertBefore(wrap, textarea); wrap.appendChild(textarea); wrap.appendChild(bar);

    function updateCount(){ const n=(textarea.value||'').length; count.textContent = n+' characters'; if (analyze){ analyze.disabled = n===0; analyze.setAttribute('aria-disabled', String(n===0)); analyze.type='button'; } }
    textarea.addEventListener('input', ()=>{ try{localStorage.setItem('mlr_text', textarea.value);}catch{} updateCount(); });
    updateCount();

    function insertAtCursorLocal(text){ // local helper for composer scope
      const start = textarea.selectionStart ?? textarea.value.length;
      const end   = textarea.selectionEnd ?? textarea.value.length;
      const before = textarea.value.slice(0, start);
      const after  = textarea.value.slice(end);
      const needsLeadingNewline = before && !before.endsWith('\\n');
      const insertion = (needsLeadingNewline ? '\\n' : '') + text;
      textarea.value = before + insertion + after;
      const newPos = (before + insertion).length;
      textarea.selectionStart = textarea.selectionEnd = newPos;
      const ev = new Event('input', { bubbles: true });
      textarea.dispatchEvent(ev);
    }

    async function handleFile(file){
      if (!file) return;
      try{ localStorage.setItem('mlr_upload_name', file.name);}catch{};
      badge.textContent = file.name;
      removeBtn.style.display = 'inline-block';
      // Insert ONLY filename into the textarea (no brackets, no file content)
      insertAtCursorLocal(file.name);
      const fileNameInput = document.getElementById('fileName'); if (fileNameInput){ fileNameInput.value = file.name; try{localStorage.setItem('mlr_upload_name', file.name);}catch{} }
    }
    fileInput.addEventListener('change', async ()=>{ const f=fileInput.files&&fileInput.files[0]; await handleFile(f); });

    function addDnD(el){ ['dragenter','dragover'].forEach(evt=>el.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); wrap.classList.add('dragging'); })); ['dragleave','drop'].forEach(evt=>el.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); wrap.classList.remove('dragging'); })); el.addEventListener('drop', async e=>{ const f=e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files[0]; await handleFile(f); }); }
    addDnD(wrap);
    // Also capture global drop
    window.addEventListener('dragover', e=>e.preventDefault()); window.addEventListener('drop', e=>{ e.preventDefault(); const f=e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files[0]; if (f) handleFile(f); });

    // Analyze click preserves state + hash
    analyze && analyze.addEventListener('click', ()=>{ const txt=(textarea.value||'').trim(); if(!txt){ textarea.focus(); return;} try{ const selVal = (localStorage.getItem('mlr_product')||''); localStorage.setItem('mlr_text', txt); const fname = localStorage.getItem('mlr_upload_name')||''; const state = encodeURIComponent(JSON.stringify({p:selVal,t:txt,n:fname})); window.location.href='results.html#s='+state; }catch{ window.location.href='results.html'; } });
  })();

  // ===== Product combobox (no prefill, no auto-open) =====
  (function productCombo(){
    const sel = document.getElementById('product'); if(!sel) return;
    // Insert wrapper before select
    const wrap=document.createElement('div'); wrap.className='combo-wrap'; wrap.setAttribute('role','combobox'); wrap.setAttribute('aria-haspopup','listbox'); wrap.setAttribute('aria-expanded','false'); wrap.setAttribute('aria-owns','product-listbox');
    const input=document.createElement('input'); input.id='productInput'; input.className='combo-input'; input.type='text'; input.autocomplete='off'; input.placeholder='Select Product…'; input.setAttribute('aria-autocomplete','both'); input.setAttribute('aria-controls','product-listbox');
    const ghost=document.createElement('div'); ghost.id='productGhost'; ghost.className='combo-ghost'; ghost.setAttribute('aria-hidden','true');
    const caret=document.createElement('div'); caret.className='combo-caret'; caret.innerHTML='&#9662;';
    const list=document.createElement('ul'); list.id='product-listbox'; list.className='combo-list'; list.setAttribute('role','listbox'); list.setAttribute('aria-hidden','true');
    sel.parentNode.insertBefore(wrap, sel); wrap.appendChild(input); wrap.appendChild(ghost); wrap.appendChild(caret); wrap.appendChild(list);
    sel.style.display='none'; // hide native select

    const PRODUCTS=[]; for(const opt of sel.options){ if(opt.text) PRODUCTS.push(opt.text.trim()); }
    const norm=s=>(s||'').toLowerCase().normalize('NFKD');
    function filter(q){ const nq=norm(q); if(!nq) return PRODUCTS.slice(0,50); const a=[],b=[]; for(const p of PRODUCTS){ const np=norm(p); if(np.startsWith(nq)) a.push(p); else if(np.includes(nq)) b.push(p);} return a.concat(b).slice(0,50); }
    function setExpanded(open){ wrap.setAttribute('aria-expanded', String(!!open)); list.setAttribute('aria-hidden', String(!open)); }
    function render(items, active=-1){ list.innerHTML=''; items.forEach((label,i)=>{ const li=document.createElement('li'); li.role='option'; li.id='product-opt-'+i; li.textContent=label; if(i===active) li.setAttribute('aria-selected','true'); li.addEventListener('mousedown',e=>{ e.preventDefault(); commit(label); }); list.appendChild(li); }); /* no auto open */ }
    function updateGhost(pred){ if(document.activeElement!==input || !input.value){ ghost.textContent=''; return; } const q=input.value; if(!pred || norm(pred).indexOf(norm(q))!==0){ ghost.textContent=''; return;} ghost.textContent=q+pred.slice(q.length); }
    function commit(value){ input.value=value; ghost.textContent=''; // sync to hidden select & storage
      for(let i=0;i<sel.options.length;i++){ if(sel.options[i].text.trim()===value){ sel.selectedIndex=i; break; } }
      try{ localStorage.setItem('mlr_product', value);}catch{} setExpanded(false);
    }
    let items=filter(''), active=-1; render(items,active);
    input.addEventListener('focus', ()=>{ items=filter(input.value); active=-1; render(items,active); setExpanded(true); });
    input.addEventListener('input', ()=>{ items=filter(input.value); active=-1; render(items,active); updateGhost(items[0]); setExpanded(true); });
    input.addEventListener('keydown', e=>{ const k=e.key; if(k==='ArrowDown'){ e.preventDefault(); if(!items.length) return; active=(active+1)%items.length; render(items,active);} else if(k==='ArrowUp'){ e.preventDefault(); if(!items.length) return; active=(active-1+items.length)%items.length; render(items,active);} else if(k==='Enter'){ if(active>=0 && items[active]){ e.preventDefault(); commit(items[active]); } else if(items[0]){ e.preventDefault(); commit(items[0]); } } else if(k==='Tab'){ if(ghost.textContent && items[0]) commit(items[0]); } else if(k==='Escape'){ setExpanded(false); active=-1;} });
    document.addEventListener('click', e=>{ if(!wrap.contains(e.target)) setExpanded(false); });
    caret.addEventListener('click', e=>{ e.stopPropagation(); if(list.getAttribute('aria-hidden')==='true'){ items=filter(input.value); render(items,active); setExpanded(true); input.focus(); } else setExpanded(false); });
  })();
});
</script>


<script>
(function mergeCounterToBottom(){
  function findLimitNode(){
    // Look for an element that contains '/5000' on the page
    const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);
    let node, el;
    while ((node = walker.nextNode())){
      if (/\s*\/\s*5000\s*characters/i.test(node.textContent || '')) {
        el = node.parentElement;
        break;
      }
    }
    if (el) { el.id = 'limitCounter'; el.setAttribute('aria-live','polite'); el.setAttribute('aria-atomic','true'); }
    return el;
  }
  const limitEl = findLimitNode();
  const textarea = document.getElementById('paste');
  const analyze  = document.getElementById('analyze');

  function update(){
    const n = (textarea && textarea.value ? textarea.value.length : 0);
    if (limitEl){
      limitEl.textContent = n + ' / 5000 characters';
    }
    if (analyze){
      analyze.disabled = n === 0;
      analyze.setAttribute('aria-disabled', String(n === 0));
      analyze.type = 'button';
    }
  }

  // Remove any old top-right live count if it exists
  const oldCount = document.getElementById('charCount');
  if (oldCount && oldCount.parentElement){
    oldCount.parentElement.removeChild(oldCount);
  }

  // Initialize and bind
  update();
  if (textarea){
    textarea.addEventListener('input', update);
  }
})();
</script>


<!-- Attachment chip + filename display with remove button (waits for composer & no bracket markers) -->
<script>
(function attachmentUI(){
  function init(){
    const textarea = document.getElementById('paste');
    if (!textarea) return;
    const fileInput = document.getElementById('fileInput');

    // Prefer composer-wrap once created
    const wrap = textarea.closest('.composer-wrap') || textarea.parentElement;
    const barRight = wrap && wrap.querySelector('.composer-bar') ? wrap.querySelector('.composer-bar').lastElementChild : null;
    const badge = document.getElementById('fileBadge') || (barRight && barRight.querySelector('#fileBadge'));

    // Ensure a fallback remove button exists next to the badge
    let removeBtn = document.getElementById('fileRemoveBtn');
    if (!removeBtn && barRight){
      removeBtn = document.createElement('button');
      removeBtn.id = 'fileRemoveBtn';
      removeBtn.type = 'button';
      removeBtn.textContent = 'Remove';
      removeBtn.title = 'Remove attachment';
      removeBtn.setAttribute('aria-label','Remove attachment');
      removeBtn.style.display = 'none';
      barRight.appendChild(removeBtn);
    }

    // Create or reuse chip element
    let chip = document.getElementById('fileChip');
    if (!chip){
      chip = document.createElement('div');
      chip.id = 'fileChip';
      chip.className = 'file-chip';
      chip.setAttribute('hidden','');
      const nameSpan = document.createElement('span'); nameSpan.id = 'fileChipName';
      const xBtn = document.createElement('button'); xBtn.type='button'; xBtn.title='Remove attachment'; xBtn.setAttribute('aria-label','Remove attachment'); xBtn.textContent='×';
      xBtn.addEventListener('click', clearFilename);
      chip.appendChild(nameSpan); chip.appendChild(xBtn);
      // Append to composer-wrap so absolute positioning works
      const composerWrap = textarea.closest('.composer-wrap') || wrap;
      composerWrap.appendChild(chip);
    }

    const chipName = document.getElementById('fileChipName');

    function showFilename(name){
      if (badge) badge.textContent = name || '';
      if (removeBtn) removeBtn.style.display = name ? 'inline-block' : 'none';
      if (name){
        if (chipName) chipName.textContent = name;
        chip.removeAttribute('hidden');
      } else {
        chip.setAttribute('hidden','');
      }
    }

    function rememberFilename(name){
      try { localStorage.setItem('mlr_upload_name', name || ''); } catch {}
    }

    function clearFilename(){
      try { localStorage.removeItem('mlr_upload_name'); } catch {}
      showFilename('');
    }

    // Hydrate from storage on load
    try {
      const stored = localStorage.getItem('mlr_upload_name');
      if (stored) showFilename(stored);
    } catch {}

    // Listen to file input
    if (fileInput){
      fileInput.addEventListener('change', ()=>{
        const f = fileInput.files && fileInput.files[0];
        if (f){ rememberFilename(f.name); showFilename(f.name); }
      });
    }

    // Also listen to global drop
    window.addEventListener('drop', (e)=>{
      const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
      if (f){ rememberFilename(f.name); showFilename(f.name); }
    }, true);
  }

  // Wait for DOMContentLoaded and for composer-wrap to exist
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', waitForComposer);
  } else {
    waitForComposer();
  }

  function waitForComposer(){
    const check = () => {
      const ta = document.getElementById('paste');
      const hasComposer = ta && ta.closest('.composer-wrap');
      if (hasComposer){
        init();
      } else {
        requestAnimationFrame(check);
      }
    };
    check();
  }
})();
</script>


<script>
(function cleanStartUnlessShareState(){
  const hasShare = new URLSearchParams(location.hash.slice(1)).has('s');
  if (!hasShare){
    try { 
      localStorage.removeItem('mlr_upload_name'); 
      localStorage.removeItem('mlr_text');  // ensure no stale text appears
    } catch {}
  }
})();
</script>

</body>
</html>

<!-- Persist inputs & expand drag/drop WITHOUT changing styles -->
<script>
(function enhanceReview(){
  try{
    const textarea  = document.getElementById('paste');
    const charCount = document.getElementById('charCount');
    const product   = document.getElementById('product');
    const fileInput = document.getElementById('fileInput');
    const drop      = document.getElementById('drop');
    const card      = document.querySelector('section.card.pad[aria-labelledby="content-title"]') || document.querySelector('section.card.pad');

    // Only hydrate saved text if we have a share state in the URL hash
    const hasShare = new URLSearchParams(location.hash.slice(1)).has('s');
    const savedText = hasShare ? (localStorage.getItem('mlr_text') || '') : '';

    if (textarea){ textarea.value = savedText; if (charCount) charCount.textContent = textarea.value.length; }

    const savedProd = localStorage.getItem('mlr_product');
    if (product && savedProd){ product.value = savedProd; }

    // Save on every change
    if (textarea){
      textarea.addEventListener('input', () => {
        if (charCount) charCount.textContent = textarea.value.length;
        localStorage.setItem('mlr_text', textarea.value);
      });
    }
    if (product){
      product.addEventListener('change', () => {
        localStorage.setItem('mlr_product', product.value);
      });
    }

    // Expand drag/drop to the whole card to feel chat-like (aesthetic unchanged)
    if (card && drop){
      ['dragover','dragenter'].forEach(ev =>
        card.addEventListener(ev, e => { e.preventDefault(); drop.style.borderColor = '#a5b4fc'; })
      );
      ['dragleave','drop'].forEach(ev =>
        card.addEventListener(ev, e => { e.preventDefault(); drop.style.borderColor = '#cfd8e3'; })
      );
      card.addEventListener('drop', (e) => {
        const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
        if (f) { localStorage.setItem('mlr_upload_name', f.name); }
      });
    }

    // Also persist filename on manual attach
    if (fileInput){
      fileInput.addEventListener('change', () => {
        if (fileInput.files && fileInput.files[0]) {
          localStorage.setItem('mlr_upload_name', fileInput.files[0].name);
        }
      });
    }
  }catch(e){ console.warn('enhanceReview error', e); }
})();
</script>
