<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Review — MLR Assistant</title>
  <style>
    :root{
      /* Use existing design tokens if present; fallback values only */
      --surface: #fff;
      --bg: #fafafa;
      --text: #111;
      --muted: #6b7280;
      --border: #e5e7eb;
      --hover: rgba(0,0,0,.04);
      --primary: #111;
      --shadow: 0 8px 30px rgba(0,0,0,.08);
      --radius: 16px;
      --radius-sm: 12px;
      --radius-lg: 20px;
    }
    * { box-sizing: border-box; }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
      line-height:1.4;
    }
    header{
      position: sticky; top:0; z-index:5;
      background: var(--surface);
      border-bottom:1px solid var(--border);
    }
    .wrap{ max-width: 1200px; margin-inline:auto; padding: 16px 20px; }
    h1{ font-size: 20px; margin:0; }
    main .wrap{ padding-block: 24px; }
    .grid{
      display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 24px;
    }
    @media (max-width: 960px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--surface);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .card .hd{ padding: 14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px; }
    .card .bd{ padding: 16px; }

    .field{ display:grid; gap:8px; margin-bottom:12px; }
    label{ font-weight:600; font-size: 14px; }

    /* Composer (unified input) */
    .composer{
      position: relative;
      display: grid;
      grid-template-rows: 1fr auto;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      background: var(--surface);
    }
    .composer.dragging{ outline: 2px dashed var(--primary); outline-offset: -6px; }
    .composer textarea{
      width: 100%; border:0; resize: vertical; min-height: 200px; padding: 14px 16px 16px 16px;
      font: inherit; background: transparent; color: inherit; line-height: 1.5;
    }
    .composer .bar{
      display:flex; gap:8px; align-items:center; justify-content:space-between;
      padding: 10px 12px; border-top:1px solid var(--border); background: #fff;
    }
    .left{ display:flex; gap:8px; align-items:center; }
    .btn{
      appearance:none; border:1px solid var(--border); background: var(--surface);
      padding: 8px 12px; border-radius: var(--radius-sm); cursor: pointer; font: inherit;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
    }
    .btn:hover{ background: var(--hover); }
    .btn.primary{
      background: var(--text); color:#fff; border-color: var(--text);
    }
    .muted{ color: var(--muted); font-size: 13px; }
    .help{ font-size: 12px; color: var(--muted); margin-top:4px; }

    /* Hidden input remains for compatibility */
    input[type="file"]{ display:none; }

    /* Simple product + filename row */
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    select, input[type="text"]{
      width: 100%; border:1px solid var(--border); padding:10px 12px; border-radius: var(--radius-sm);
      background: var(--surface); font: inherit;
    }
    .w-60{ flex:1 1 60%; min-width: 260px; }
    .w-40{ flex:1 1 40%; min-width: 220px; }

    .pill{
      display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px;
      border: 1px solid var(--border); background: var(--surface);
    }
    .sr-only{
      position:absolute !important; height:1px; width:1px; overflow:hidden;
      clip: rect(1px, 1px, 1px, 1px); white-space: nowrap; border:0; padding:0; margin:-1px;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <h1>Review</h1>
      <div class="pill">
        <span id="uploadName" class="muted">No file selected</span>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap grid">
      <!-- Left: unified input composer -->
      <section class="card">
        <div class="hd">
          <strong>Content</strong>
        </div>
        <div class="bd">
          <div class="field">
            <label for="paste">Paste or write your text</label>
            <div id="composer" class="composer" aria-label="Type your text. You can also drag and drop a file here." aria-describedby="composerHelp">
              <textarea id="paste" placeholder="Type or paste here…"></textarea>
              <div class="bar">
                <div class="left">
                  <input type="file" id="fileInput" accept=".txt,.doc,.docx,.pdf,.rtf,.md,.html,.csv"/>
                  <button class="btn" id="uploadBtn" type="button" aria-label="Upload a file">Upload</button>
                  <span id="dropHint" class="muted">or drag &amp; drop a file</span>
                </div>
                <div>
                  <span id="charCount" class="muted" aria-live="polite" aria-atomic="true">0</span>
                </div>
              </div>
            </div>
            <div id="composerHelp" class="help">
              Tip: dropping a .txt file will auto-fill the editor. Other formats will attach the filename and keep your typed text.
            </div>
          </div>

          <div class="row" style="margin-top:8px;">
            <div class="w-60">
              <label for="product">Product</label>
              <!-- Keep the original select ID for compatibility; options are placeholders and can be adjusted -->
              <select id="product">
                <option value="" disabled selected>Select a product…</option>
                <option>Clareon PanOptix IOL</option>
                <option>Total 30 Contact Lens</option>
                <option>Clareon Vivity IOL</option>
                <option>PRECISION1 Contact Lens</option>
              </select>
            </div>
            <div class="w-40">
              <label for="fileName">Attached file name</label>
              <input id="fileName" type="text" placeholder="Optional" />
            </div>
          </div>

          <div style="margin-top:14px; display:flex; justify-content:flex-end; gap:8px;">
            <button class="btn" id="clear" type="button">Clear</button>
            <button class="btn primary" id="analyze" type="button" aria-disabled="true">Analyze</button>
          </div>
        </div>
      </section>

      <!-- Right: quick guidance (optional placeholder) -->
      <aside class="card">
        <div class="hd"><strong>Guidance</strong></div>
        <div class="bd">
          <p class="muted">Paste or type copy in the box. Upload a document or drag a file onto the same area. Character count updates as you type. Click Analyze to continue to Results.</p>
        </div>
      </aside>
    </div>
  </main>

  <script>
    // Utilities
    const $ = sel => document.querySelector(sel);

    const textarea  = $('#paste');
    const charCount = $('#charCount');
    const analyze   = $('#analyze');
    const uploadBtn = $('#uploadBtn');
    const fileInput = $('#fileInput');
    const composer  = $('#composer');
    const product   = $('#product');
    const nameField = $('#fileName');
    const uploadName= $('#uploadName');

    function updateCharCount(){
      const n = (textarea.value || '').length;
      charCount.textContent = n + ' characters';
      analyze.disabled = n === 0;
      analyze.setAttribute('aria-disabled', String(n === 0));
    }

    function setUploadName(name){
      uploadName.textContent = name ? name : 'No file selected';
      nameField.value = name || '';
      try { localStorage.setItem('mlr_upload_name', name || ''); } catch {}
    }

    // Persist text/product on load
    (function hydrate(){
      try {
        const txt = localStorage.getItem('mlr_text') || '';
        const prod = localStorage.getItem('mlr_product') || '';
        const fname = localStorage.getItem('mlr_upload_name') || '';
        if (txt) textarea.value = txt;
        if (prod) product.value = prod;
        if (fname) setUploadName(fname);
      } catch {}
      updateCharCount();
    })();

    // Text input handlers
    textarea.addEventListener('input', () => {
      updateCharCount();
      try { localStorage.setItem('mlr_text', textarea.value); } catch {}
    });

    // File ingestion
    async function handleFile(file){
      if (!file) return;
      setUploadName(file.name);

      // Auto-ingest .txt into the textarea
      if (/\\.txt$/i.test(file.name)) {
        const text = await file.text();
        textarea.value = text;
        try { localStorage.setItem('mlr_text', text); } catch {}
        updateCharCount();
      }
      // For other formats, we keep text as-is but persist filename for continuity
    }

    uploadBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', async () => {
      const f = fileInput.files && fileInput.files[0];
      await handleFile(f);
    });

    // Drag & drop on the same composer
    ;['dragenter','dragover'].forEach(evt => composer.addEventListener(evt, e => {
      e.preventDefault(); e.stopPropagation();
      composer.classList.add('dragging');
    }));
    ;['dragleave','drop'].forEach(evt => composer.addEventListener(evt, e => {
      e.preventDefault(); e.stopPropagation();
      composer.classList.remove('dragging');
    }));
    composer.addEventListener('drop', async (e) => {
      const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
      await handleFile(f);
    });

    // Keep filename field bound to header pill + localStorage
    nameField.addEventListener('input', () => setUploadName(nameField.value));

    // Keep product persisted
    product.addEventListener('change', () => {
      try { localStorage.setItem('mlr_product', product.value); } catch {}
    });

    // Clear
    $('#clear').addEventListener('click', () => {
      textarea.value = '';
      updateCharCount();
      setUploadName('');
      try {
        localStorage.removeItem('mlr_text');
        localStorage.removeItem('mlr_upload_name');
      } catch {}
      textarea.focus();
    });

    // Analyze -> navigate (preserve state; also support shareable hash)
    analyze.addEventListener('click', () => {
      const txt = textarea.value.trim();
      if (!txt) { textarea.focus(); return; }
      try {
        localStorage.setItem('mlr_text', txt);
        localStorage.setItem('mlr_product', product.value);
        // Also encode share state for Results deep-link (optional)
        const state = encodeURIComponent(JSON.stringify({p:product.value,t:txt,n:(nameField.value || '')}));
        window.location.href = 'results.html#s=' + state;
      } catch {
        window.location.href = 'results.html';
      }
    });
  </script>
</body>
</html>
