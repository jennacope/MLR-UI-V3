<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alcon MLR Pre-Screening Agent – Results (Two-Card Score)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --alcon-blue:#0072CE;
      --alcon-blue-600:#035bb0;
      --bg:#F6F8FB;
      --text:#1F2937;
      --muted:#6B7280;
      --card:#FFFFFF;
      --border:#E5E7EB;
      --shadow:0 10px 20px rgba(16,24,40,.06),0 2px 6px rgba(16,24,40,.06);
      --green:#12B76A;
      --amber:#FEC84B;
      --red:#D92D20;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);background:var(--bg);line-height:1.45}

    .topbar{background:var(--card);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50;}
    .topbar .inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;justify-content:space-between;padding:14px 20px;}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .logo{width:28px;height:28px;border-radius:6px;background:var(--alcon-blue);box-shadow:inset 0 -8px 16px rgba(255,255,255,.25);}
    .brand span{color:var(--alcon-blue)}
    .crumbs{font-size:12px;color:var(--muted)}
    .avatar{width:32px;height:32px;border-radius:999px;background:linear-gradient(135deg,#c7d2fe,#e0e7ff);display:grid;place-items:center;font-weight:600;color:#334155}

    .wrap{display:flex;justify-content:center}
    .grid{max-width:1400px;width:100%;margin:0 auto;display:grid;grid-template-columns: 1.6fr 0.8fr;gap:16px;padding:16px}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .card h3{margin:0 0 8px;font-size:16px}
    .card .sub{font-size:12px;color:var(--muted)}

    .section-title{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:12px}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    .btn{font-family:inherit;font-size:14px;border-radius:12px;border:1px solid var(--alcon-blue);padding:10px 12px;background:#fff;color:var(--alcon-blue);text-decoration:none;display:inline-flex;align-items:center}

    /* Donut */
    .donut{--val:68; --color:var(--amber); width:120px;height:120px;border-radius:50%;display:grid;place-items:center;background:
      conic-gradient(var(--color) calc(var(--val)*1%),#e5e7eb 0);
      position:relative;
    }
    .donut::after{content:"";position:absolute;inset:12px;background:#fff;border-radius:50%;}
    .donut span{position:relative;font-weight:700;color:#111;font-size:18px}
    .score-wrap{display:flex;align-items:center;gap:20px}

    /* Two-card area for the score widgets */
    .score-grid{display:grid;grid-template-columns: 1fr 1fr;gap:16px;margin-top:8px}
    @media (max-width:900px){.score-grid{grid-template-columns:1fr}}

    /* Standards card */
    .bar{height:6px;background:#eef2f7;border-radius:6px;overflow:hidden;width:160px;margin-left:8px}
    .bar > i{display:block;height:100%;background:var(--alcon-blue);}
    .std-row{display:grid;grid-template-columns: 1fr 160px 120px;align-items:center;gap:10px;margin:10px 0;}
    .std-name{font-size:14px;color:var(--text)}
    .hint{position:relative;cursor:help}
    .hint[data-hint]:hover::after,.hint[data-hint]:focus::after{
      content:attr(data-hint);position:absolute;left:0;top:115%;background:#fff;border:1px solid var(--border);
      border-radius:10px;box-shadow:var(--shadow);padding:8px 10px;font-size:12px;color:var(--text);width:260px;z-index:10
    }

    /* Preview */
    .preview{border-radius:12px;border:1px dashed var(--border);background:#FBFCFE;margin-bottom:14px;padding:14px}
  </style>
</head>
<body>
  <header class="topbar" role="banner">
    <div class="inner">
      <div class="brand" aria-label="Alcon">
        <div class="logo" aria-hidden="true"></div>
        <span>Alcon</span>
        <div class="crumbs">MLR Pre-Screening Agent · Results</div>
      </div>
      <div class="avatar" aria-label="User avatar" title="Sarah Chen">SC</div>
    </div>
  </header>

  <main class="wrap" role="main">
    <div class="grid">
      <section class="card" aria-labelledby="content-title">
        <div class="section-title">
          <div>
            <h3 id="content-title">Results</h3>
            <div class="sub" id="prodLabel">Analysis for: —</div>
          </div>
          <div class="controls">
            <a href="review.html" class="btn">← Back to Review</a>
          </div>
        </div>

        <div class="preview">
          <div class="sub" style="margin-bottom:8px">Submitted Content (preview)</div>
          <div id="preview" style="white-space:pre-wrap;font-size:14px;color:#111;max-height:160px;overflow:auto"></div>
        </div>

        <!-- Two-card layout -->
        <div class="score-grid">
          <!-- Card A: Overall Compliance Score (donut only + label) -->
          <div class="card">
            <h3>Overall Compliance Score</h3>
            <div class="sub">Calculated from FDA, FTC, MLR, and Internal standards.</div>
            <div class="score-wrap" style="margin-top:10px">
              <div class="donut" id="donut" aria-label="Overall compliance score"><span id="scoreNum">—</span></div>
              <div>
                <div class="pill" id="scoreLabel" style="display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#FFF8E1;color:#8a5800;font-size:12px;border:1px solid #FEE4A8">Calculating…</div>
                <div class="sub" style="margin-top:8px">Higher is better. Color of ring reflects thresholds (85+ green, 70–84 amber, below 70 red).</div>
              </div>
            </div>
          </div>

          <!-- Card B: Breakdown by Standards -->
          <div class="card">
            <h3>Breakdown by Standards</h3>
            <div class="sub">Each row shows the % of content that is compliant for that standard.</div>
            <div style="margin-top:8px">
              <div class="std-row">
                <span class="std-name hint" data-hint="FDA: claim substantiation, fair balance of benefits/risks, required safety info">FDA Compliance</span>
                <div class="bar"><i id="barFDA"></i></div>
                <span id="pctFDA">—% compliant</span>
              </div>
              <div class="std-row">
                <span class="std-name hint" data-hint="FTC: truthful, non‑misleading advertising; avoid absolute/superiority claims without evidence">FTC Compliance</span>
                <div class="bar"><i id="barFTC"></i></div>
                <span id="pctFTC">—% compliant</span>
              </div>
              <div class="std-row">
                <span class="std-name hint" data-hint="MLR: Medical/Legal/Regulatory expectations for claims, references, disclaimers">MLR Compliance</span>
                <div class="bar"><i id="barMLR"></i></div>
                <span id="pctMLR">—% compliant</span>
              </div>
              <div class="std-row">
                <span class="std-name hint" data-hint="Internal Standards: Alcon policies, MLR conventions, house style, required placements">Internal Standards</span>
                <div class="bar"><i id="barINT"></i></div>
                <span id="pctINT">—% compliant</span>
              </div>
            </div>
          </div>
        </div>

        <!-- You can keep your detailed analysis cards below if desired -->

      </section>
    </div>
  </main>

  <script>
    // Rehydrate labels
    const text = localStorage.getItem('mlr_text') || '';
    const product = localStorage.getItem('mlr_product') || '—';
    const uploadName = localStorage.getItem('mlr_upload_name') || '';
    (function updateProdLabel(){
      const base = `Analysis for: ${product}`;
      const suffix = uploadName ? ` · File: ${uploadName}` : '';
      const el = document.getElementById('prodLabel');
      if (el) el.textContent = base + suffix;
    })();
    document.getElementById('preview').textContent = text || '(No text was provided. If you uploaded a file, analysis is based on file contents.)';

    // Very simple pattern hits (stub for your real rules)
    const riskyRules = [
      /world[’'`]?s?\s+most\s+advanced/i,
      /safest/i,
      /most\s+effective/i,
      /guarantee(d)?/i,
      /perfect\s+vision/i
    ];
    const hasHit = riskyRules.some(r => r.test(text));

    // Base subscores (anchor to your earlier aesthetic logic)
    let base = Math.min(96, Math.max(42, Math.round(42 + Math.log((text && text.length) ? text.length : 1) * 10)));
    let fda  = Math.max(50, Math.min(95, base - 6));
    let ftc  = Math.max(55, Math.min(96, base - 2));
    let mlr  = Math.max(55, Math.min(97, base + 2));
    let intl = Math.max(60, Math.min(98, base + 8));

    // Simple penalty if any risky pattern appears (replace with your granular rules as needed)
    if (hasHit){ fda-=12; ftc-=10; mlr-=9; intl-=4; }
    const clamp = v => Math.max(0, Math.min(100, Math.round(v)));
    fda=clamp(fda); ftc=clamp(ftc); mlr=clamp(mlr); intl=clamp(intl);

    // Weighted overall (explicit relation)
    const W = { fda:0.40, ftc:0.25, mlr:0.20, intl:0.15 };
    const overall = clamp(fda*W.fda + ftc*W.ftc + mlr*W.mlr + intl*W.intl);

    // Render Standards card
    function renderRow(id,val){
      const pct = document.getElementById('pct'+id);
      const bar = document.getElementById('bar'+id);
      if (pct) pct.textContent = val + '% compliant';
      if (bar) bar.style.width = val + '%';
    }
    renderRow('FDA',fda);
    renderRow('FTC',ftc);
    renderRow('MLR',mlr);
    renderRow('INT',intl);

    // Render donut card
    const donut = document.getElementById('donut');
    const scoreNum = document.getElementById('scoreNum');
    const scoreLabel = document.getElementById('scoreLabel');
    donut.setAttribute('role','img'); donut.setAttribute('aria-live','polite');
    function setDonut(s){
      scoreNum.textContent = s;
      donut.style.setProperty('--val', s);
      const css = getComputedStyle(document.documentElement);
      const green = css.getPropertyValue('--green');
      const amber = css.getPropertyValue('--amber');
      const red   = css.getPropertyValue('--red');
      const labelText = s >= 85 ? 'Compliant – minor cautions'
                      : s >= 70 ? 'Needs Review – some issues found'
                                : 'High Risk – multiple critical issues';
      donut.style.setProperty('--color', s >= 85 ? green : (s >= 70 ? amber : red));
      scoreLabel.textContent = labelText;
      donut.setAttribute('aria-label', `Overall compliance score ${s}. ${labelText}.`);
    }
    setDonut(overall);

    // Back behavior preserving state
    (function persistSelectionAndBack() {
      try {
        localStorage.setItem('mlr_keep_selection', '1');
        const back = document.querySelector('a.btn[href="review.html"]');
        if (back) {
          back.addEventListener('click', function(e){
            e.preventDefault();
            localStorage.setItem('mlr_return_anchor', 'results');
            if (history.length > 1) history.back(); else window.location.href = 'review.html?from=results';
          });
        }
      } catch (e) { console.warn('persistSelectionAndBack error', e); }
    })();
  </script>
</body>
</html>
